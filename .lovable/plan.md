

## Fix: Duplicate Key Error When Creating Job Orders

### Problem
The duplicate key error persists because the `generate_job_order_number()` database function fix only covers one creation path. There are **two code paths** that create job orders:

1. **CreateJobOrderDialog / ImportWorkOrderDialog** -- passes `number: ""`, correctly triggering the DB function.
2. **Estimate-to-Job-Order conversion** (`src/integrations/supabase/hooks/useEstimates.ts`, lines 489-513) -- generates its own number client-side using a **different format** (`JO-2024-001`) and passes it directly in the insert. This bypasses the trigger entirely (since the number is not null/empty) and uses a flawed numbering logic that can produce duplicates.

### Solution
Remove the client-side number generation in `useEstimates.ts` and pass `number: ""` instead, letting the database trigger handle it consistently across all creation paths.

### Technical Details

**File: `src/integrations/supabase/hooks/useEstimates.ts`**

- Remove lines 489-506 (the client-side number generation logic)
- Change line 513 from `number: jobOrderNumber` to `number: ""`

This ensures all job order numbers are generated by the same database function with the advisory lock, eliminating race conditions and format inconsistencies.

### Files to Modify

| File | Purpose |
|------|---------|
| `src/integrations/supabase/hooks/useEstimates.ts` | Remove client-side JO number generation; use `number: ""` to let DB trigger handle it |

